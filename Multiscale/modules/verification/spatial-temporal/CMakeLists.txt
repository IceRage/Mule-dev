#------------------------------------------------------------
# Include directories
#------------------------------------------------------------

include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/test)


#------------------------------------------------------------
# Specify link directories
#------------------------------------------------------------

link_directories(${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/util)


#------------------------------------------------------------
# Generate source files considering the configuration file
# config/verification/spatial-temporal/spatial_description.xml 
# if any of them are missing
#------------------------------------------------------------

set(CUSTOM_GENERATED_DEPENDENCY_FILES
    "${PROJECT_SOURCE_DIR}/config/verification/spatial-temporal/schema/MSTML_L1V1.xsd"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/include/multiscale/verification/spatial-temporal/attribute/SpatialMeasureType.hpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/include/multiscale/verification/spatial-temporal/attribute/SubsetSpecificType.hpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/include/multiscale/verification/spatial-temporal/parsing/SymbolTablesAutoGenerated.hpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/sample/ParserEvaluationSample.cpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/src/attribute/SpatialMeasureAttributeAutoGenerated.cpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/src/attribute/SubsetSpecificAttributeAutoGenerated.cpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/src/data/SpatialTemporalDataReaderAutoGenerated.cpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/test/checking/ModelCheckerTest.hpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/test/evaluation/CompleteTraceTest.hpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/test/evaluation/EmptyTraceTest.hpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/test/evaluation/NumericStateVariableTraceTest.hpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/test/evaluation/SpatialEntitiesTraceTest.hpp"
    "${PROJECT_SOURCE_DIR}/modules/verification/spatial-temporal/test/parsing/ParserTest.hpp"
)

foreach(DEPENDENT_FILE ${CUSTOM_GENERATED_DEPENDENCY_FILES})
    if(NOT EXISTS "${DEPENDENT_FILE}")
        execute_process(
            COMMAND python "${PROJECT_SOURCE_DIR}/script/verification/generator/generator.py" "${PROJECT_SOURCE_DIR}/config/verification/spatial-temporal/generator/spatial_description.xml" "${PROJECT_SOURCE_DIR}/config/verification/spatial-temporal/generator/spatial_description.xsd"
            WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
        )
    endif(NOT EXISTS "${DEPENDENT_FILE}")
endforeach(DEPENDENT_FILE)


#------------------------------------------------------------
# Generate source files considering the configuration file
# config/verification/spatial-temporal/spatial_description.xml 
# if any of them have been updated since the last build
#------------------------------------------------------------

if("${CMAKE_CUSTOM_MODEL_CHECKER}" STREQUAL "Generate")
    # Configure the Python generator script
    configure_file(
        ${PROJECT_SOURCE_DIR}/script/verification/generator/generator.py.in
        ${PROJECT_SOURCE_DIR}/script/verification/generator/generator.py
    )
    
    # Initialise the list of output and dependent files
    set(CUSTOM_GENERATOR_OUTPUT_FILES
        "${PROJECT_SOURCE_DIR}/config/verification/spatial-temporal/schema/MSTML_L1V1.xsd"
    )
    
    set(CUSTOM_GENERATOR_DEPENDENCIES
        "${PROJECT_SOURCE_DIR}/config/verification/spatial-temporal/generator/spatial_description.xml"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/generator.py.in"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/config/verification/spatial-temporal/schema/mstml_l1v1_xsd.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/include/attribute/spatial_measure_type_hpp.tpl.in"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/include/attribute/subset_specific_type_hpp.tpl.in"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/include/model/derived_spatial_entity_hpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/include/parsing/symbol_tables_auto_generated_hpp.tpl.in"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/sample/parser_evaluation_sample_cpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/src/attribute/spatial_measure_attribute_auto_generated_cpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/src/attribute/subset_specific_attribute_auto_generated_cpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/src/data/spatial_temporal_data_reader_auto_generated_cpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/src/data/spatial_temporal_data_writer_auto_generated_cpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/test/checking/model_checker_test_hpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/test/evaluation/complete_trace_test_hpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/test/evaluation/empty_trace_test_hpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/test/evaluation/numeric_state_variable_trace_test_hpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/test/evaluation/spatial_entities_trace_test_hpp.tpl"
        "${PROJECT_SOURCE_DIR}/script/verification/generator/templates/test/parsing/parser_test_hpp.tpl"
    )
    
    # Add a custom command for running the Python generator script
    add_custom_command(
        OUTPUT ${CUSTOM_GENERATOR_OUTPUT_FILES}
        COMMAND python "${PROJECT_SOURCE_DIR}/script/verification/generator/generator.py" "${PROJECT_SOURCE_DIR}/config/verification/spatial-temporal/generator/spatial_description.xml" "${PROJECT_SOURCE_DIR}/config/verification/spatial-temporal/generator/spatial_description.xsd"
        DEPENDS ${CUSTOM_GENERATOR_DEPENDENCIES}
        WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    )
    
    # Add a custom target which executes the above defined custom command
    add_custom_target(
        custom_generator ALL
        DEPENDS ${CUSTOM_GENERATOR_OUTPUT_FILES}
    )
endif("${CMAKE_CUSTOM_MODEL_CHECKER}" STREQUAL "Generate")


#------------------------------------------------------------
# Add executables
#------------------------------------------------------------


# MultidimensionalMultiscaleModelChecker

# Update the build number of the model checker
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/src/checking/ModelCheckingOutputWriter.cpp.in
    ${CMAKE_CURRENT_SOURCE_DIR}/src/checking/ModelCheckingOutputWriter.cpp
)

# Set the path to the MSTML xml schema definition file
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/src/data/SpatialTemporalDataReader.cpp.in
    ${CMAKE_CURRENT_SOURCE_DIR}/src/data/SpatialTemporalDataReader.cpp
)

# Set the path to the type semantics table xml schema definition file
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/src/model/TypeSemanticsTable.cpp.in
    ${CMAKE_CURRENT_SOURCE_DIR}/src/model/TypeSemanticsTable.cpp
)

# Set the core model checker source files
set(CORE_MODEL_CHECKER_SRC
    src/attribute/BinaryNumericMeasureAttribute.cpp
    src/attribute/BinaryStatisticalMeasureAttribute.cpp
    src/attribute/BinaryStatisticalQuantileMeasureAttribute.cpp
    src/attribute/ChangeMeasureAttribute.cpp
    src/attribute/ComparatorAttribute.cpp
    src/attribute/HeterogeneousTimeseriesComponentAttribute.cpp
    src/attribute/HomogeneousTimeseriesComponentAttribute.cpp
    src/attribute/HomogeneousTimeseriesMeasureAttribute.cpp
    src/attribute/ProbabilisticLogicPropertyAttribute.cpp
    src/attribute/SimilarityMeasureAttribute.cpp
    src/attribute/SpatialMeasureAttributeAutoGenerated.cpp
    src/attribute/SpatialMeasureAttribute.cpp
    src/attribute/SubsetOperationAttribute.cpp
    src/attribute/SubsetSpecificAttributeAutoGenerated.cpp
    src/attribute/SubsetSpecificAttribute.cpp
    src/attribute/TimeseriesMeasureAttribute.cpp
    src/attribute/UnaryNumericMeasureAttribute.cpp
    src/attribute/UnaryStatisticalMeasureAttribute.cpp
    
    src/exception/ParserGrammarExceptionHandler.cpp
    
    src/model/AbstractSyntaxTree.cpp
    src/model/NumericStateVariableId.cpp
    src/model/ScaleAndSubsystem.cpp
    src/model/SpatialEntity.cpp
    src/model/SpatialTemporalTrace.cpp
    src/model/StateVariable.cpp
    src/model/TimePoint.cpp
    src/model/TypeSemanticsTable.cpp
    
    src/parsing/BinaryNumericMeasureGrammar.cpp
    src/parsing/BinaryStatisticalMeasureGrammar.cpp
    src/parsing/BinaryStatisticalQuantileMeasureGrammar.cpp
    src/parsing/ChangeMeasureGrammar.cpp
    src/parsing/ComparatorGrammar.cpp
    src/parsing/LogicPropertyGrammar.cpp
    src/parsing/NumericStateVariableGrammar.cpp
    src/parsing/Parser.cpp
    src/parsing/PrimaryNumericMeasureGrammar.cpp
    src/parsing/ScaleAndSubsystemGrammar.cpp
    src/parsing/ScaleAndSubsystemStringGrammar.cpp
    src/parsing/SpatialMeasureCollectionGrammar.cpp
    src/parsing/TemporalNumericCollectionGrammar.cpp
    src/parsing/TemporalNumericMeasureGrammar.cpp
    src/parsing/UnaryNumericMeasureGrammar.cpp
    src/parsing/UnaryStatisticalMeasureGrammar.cpp
    
    src/visitor/ScaleAndSubsystemEvaluator.cpp
)

# Mule

set(MULTIDIMENSIONAL_MULTISCALE_MODEL_CHECKER_SRC
    "${CORE_MODEL_CHECKER_SRC}"
    
    src/data/LogicPropertyDataReader.cpp
    src/data/SpatialTemporalDataReader.cpp
    src/data/SpatialTemporalDataReaderAutoGenerated.cpp
    
    src/checking/ApproximateBayesianModelChecker.cpp
    src/checking/ApproximateBayesianModelCheckerFactory.cpp    
    src/checking/ApproximateProbabilisticModelChecker.cpp
    src/checking/ApproximateProbabilisticModelCheckerFactory.cpp    
    src/checking/BayesianModelChecker.cpp
    src/checking/BayesianModelCheckerFactory.cpp    
    src/checking/ModelChecker.cpp
    src/checking/ModelCheckingManager.cpp
    src/checking/ModelCheckingOutputWriter.cpp
    src/checking/ProbabilisticBlackBoxModelChecker.cpp
    src/checking/ProbabilisticBlackBoxModelCheckerFactory.cpp
    src/checking/StatisticalModelChecker.cpp
    src/checking/StatisticalModelCheckerFactory.cpp
    
    src/execution/CommandLineModelChecking.cpp
    
    src/Mule.cpp 
)

AddExecutableInstallTarget(Mule "${MULTIDIMENSIONAL_MULTISCALE_MODEL_CHECKER_SRC}")
AddDebugPostfix(Mule)

target_link_libraries(Mule util)
target_link_libraries(Mule ${XERCESC_LIBRARY})


# ModelCheckerTest

set(MODEL_CHECKER_TEST_SRC
    "${CORE_MODEL_CHECKER_SRC}"
    
    src/data/LogicPropertyDataReader.cpp
    src/data/SpatialTemporalDataReader.cpp
    src/data/SpatialTemporalDataReaderAutoGenerated.cpp

    src/checking/ApproximateBayesianModelChecker.cpp
    src/checking/ApproximateBayesianModelCheckerFactory.cpp    
    src/checking/ApproximateProbabilisticModelChecker.cpp
    src/checking/ApproximateProbabilisticModelCheckerFactory.cpp    
    src/checking/BayesianModelChecker.cpp
    src/checking/BayesianModelCheckerFactory.cpp    
    src/checking/ModelChecker.cpp
    src/checking/ProbabilisticBlackBoxModelChecker.cpp
    src/checking/ProbabilisticBlackBoxModelCheckerFactory.cpp
    src/checking/StatisticalModelChecker.cpp
    src/checking/StatisticalModelCheckerFactory.cpp
    
    test/checking/ModelCheckingTest.cpp
)

set(MODEL_CHECKER_TEST_LINK_LIBS
    util
    gtest
    gtest_main
)

AddUnitTest(ModelCheckingTest "${MODEL_CHECKER_TEST_SRC}" "${MODEL_CHECKER_TEST_LINK_LIBS}")


# MSTMLSubfilesMergerTest

# Set the path to the test data
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/test/data/MSTMLSubfilesMergerTest.cpp.in
    ${CMAKE_CURRENT_SOURCE_DIR}/test/data/MSTMLSubfilesMergerTest.cpp
)

set(MSTML_SUBFILES_MERGER_SRC
    "${CORE_MODEL_CHECKER_SRC}"
    
    src/data/MSTMLSubfilesMerger.cpp
    src/data/SpatialTemporalDataReader.cpp
    src/data/SpatialTemporalDataReaderAutoGenerated.cpp
    src/data/SpatialTemporalDataWriter.cpp
    src/data/SpatialTemporalDataWriterAutoGenerated.cpp
    
    test/data/MSTMLSubfilesMergerTest.cpp   
)

set(MSTML_SUBFILES_MERGER_LINK_LIBS
    util
    gtest
    gtest_main
)

AddUnitTest(MSTMLSubfilesMergerTest "${MSTML_SUBFILES_MERGER_SRC}" "${MSTML_SUBFILES_MERGER_LINK_LIBS}")


# ParserEvaluationTest

set(PARSER_EVALUATION_TEST_SRC
    "${CORE_MODEL_CHECKER_SRC}"

    test/evaluation/ParserEvaluationTest.cpp
    test/evaluation/TraceEvaluationTest.cpp
)

set(PARSER_EVALUATION_TEST_LINK_LIBS
    util
    gtest
    gtest_main
)

AddUnitTest(ParserEvaluationTest "${PARSER_EVALUATION_TEST_SRC}" "${PARSER_EVALUATION_TEST_LINK_LIBS}")


# ParserTest

set(PARSER_TEST_SRC
    "${CORE_MODEL_CHECKER_SRC}"
    
    test/parsing/ParserTest.cpp
)

set(PARSER_TEST_LINK_LIBS
    util
    gtest
    gtest_main
)

AddUnitTest(ParserTest "${PARSER_TEST_SRC}" "${PARSER_TEST_LINK_LIBS}")


# LogicPropertyDataReaderSample

set(LOGIC_PROPERTY_DATA_READER_SAMPLE_SRC
    "${CORE_MODEL_CHECKER_SRC}"

    src/data/LogicPropertyDataReader.cpp
    
    sample/LogicPropertyDataReaderSample.cpp
)

add_executable(LogicPropertyDataReaderSample ${LOGIC_PROPERTY_DATA_READER_SAMPLE_SRC})
AddSample(LogicPropertyDataReaderSample)

target_link_libraries(LogicPropertyDataReaderSample util)


# ParserSample

set(PARSER_SAMPLE_SRC
    "${CORE_MODEL_CHECKER_SRC}"
    
    sample/ParserSample.cpp 
)


# ParserEvaluationSample

set(PARSER_EVALUATION_SAMPLE_SRC
    "${CORE_MODEL_CHECKER_SRC}"
    
    sample/ParserEvaluationSample.cpp 
)

add_executable(ParserEvaluationSample ${PARSER_EVALUATION_SAMPLE_SRC})
AddSample(ParserEvaluationSample)

target_link_libraries(ParserEvaluationSample util)


# PatternAnalysisInteractiveSample

set(PATTERN_ANALYSIS_INTERACTIVE_SAMPLE_SRC
    "${CORE_MODEL_CHECKER_SRC}"
    
    src/data/TemporalDataReader.cpp
    
    sample/PatternAnalysisInteractiveSample.cpp 
)

add_executable(PatternAnalysisInteractiveSample ${PATTERN_ANALYSIS_INTERACTIVE_SAMPLE_SRC})
AddSample(PatternAnalysisInteractiveSample)

target_link_libraries(PatternAnalysisInteractiveSample util)


# PatternAnalysisNonInteractiveSample

set(PATTERN_ANALYSIS_NONINTERACTIVE_SAMPLE_SRC
    "${CORE_MODEL_CHECKER_SRC}"
    
    src/data/LogicPropertyDataReader.cpp
    src/data/TemporalDataReader.cpp
    
    sample/PatternAnalysisNonInteractiveSample.cpp 
)

add_executable(PatternAnalysisNonInteractiveSample ${PATTERN_ANALYSIS_NONINTERACTIVE_SAMPLE_SRC})
AddSample(PatternAnalysisNonInteractiveSample)

target_link_libraries(PatternAnalysisNonInteractiveSample util)


# SpatialTemporalDataReaderSample

set(SPATIAL_TEMPORAL_DATA_READER_SAMPLE_SRC
    src/attribute/SpatialMeasureAttribute.cpp
    src/attribute/SpatialMeasureAttributeAutoGenerated.cpp
    src/attribute/SubsetOperationAttribute.cpp
    src/attribute/SubsetSpecificAttribute.cpp
    src/attribute/SubsetSpecificAttributeAutoGenerated.cpp
    
    src/data/SpatialTemporalDataReader.cpp
    src/data/SpatialTemporalDataReaderAutoGenerated.cpp
    
    src/model/NumericStateVariableId.cpp
    src/model/ScaleAndSubsystem.cpp
    src/model/SpatialEntity.cpp
    src/model/SpatialTemporalTrace.cpp
    src/model/StateVariable.cpp
    src/model/TimePoint.cpp

    sample/SpatialTemporalDataReaderSample.cpp
)

add_executable(SpatialTemporalDataReaderSample ${SPATIAL_TEMPORAL_DATA_READER_SAMPLE_SRC})
AddSample(SpatialTemporalDataReaderSample)

target_link_libraries(SpatialTemporalDataReaderSample util)
target_link_libraries(SpatialTemporalDataReaderSample ${XERCESC_LIBRARY})


# TemporalDataReaderSample

set(TEMPORAL_DATA_READER_SAMPLE_SRC
    src/attribute/SpatialMeasureAttribute.cpp
    src/attribute/SpatialMeasureAttributeAutoGenerated.cpp
    src/attribute/SubsetOperationAttribute.cpp
    src/attribute/SubsetSpecificAttribute.cpp
    src/attribute/SubsetSpecificAttributeAutoGenerated.cpp
        
    src/data/TemporalDataReader.cpp
    
    src/model/NumericStateVariableId.cpp
    src/model/ScaleAndSubsystem.cpp
    src/model/SpatialEntity.cpp
    src/model/SpatialTemporalTrace.cpp
    src/model/StateVariable.cpp
    src/model/TimePoint.cpp

    sample/TemporalDataReaderSample.cpp
)

add_executable(TemporalDataReaderSample ${TEMPORAL_DATA_READER_SAMPLE_SRC})
AddSample(TemporalDataReaderSample)

target_link_libraries(TemporalDataReaderSample util)


# TypeSemanticsTableDataReaderSample

set(TYPE_SEMANTICS_TABLE_DATA_READER_SAMPLE_SRC
    src/model/ScaleAndSubsystem.cpp
    src/model/TypeSemanticsTable.cpp

    sample/TypeSemanticsTableDataReaderSample.cpp
)

add_executable(TypeSemanticsTableDataReaderSample ${TYPE_SEMANTICS_TABLE_DATA_READER_SAMPLE_SRC})
AddSample(TypeSemanticsTableDataReaderSample)

target_link_libraries(TypeSemanticsTableDataReaderSample util)


# MSTMLSubfilesMergerSample

set(MSTML_SUBFILES_MERGER_SAMPLE_SRC
    "${CORE_MODEL_CHECKER_SRC}"

    src/data/MSTMLSubfilesMerger.cpp
    src/data/SpatialTemporalDataReader.cpp
    src/data/SpatialTemporalDataReaderAutoGenerated.cpp
    src/data/SpatialTemporalDataWriter.cpp
    src/data/SpatialTemporalDataWriterAutoGenerated.cpp

    sample/MSTMLSubfilesMergerSample.cpp
)

add_executable(MSTMLSubfilesMergerSample ${MSTML_SUBFILES_MERGER_SAMPLE_SRC})
AddSample(MSTMLSubfilesMergerSample)

target_link_libraries(MSTMLSubfilesMergerSample util)